#!/bin/bash

tee /sys/class/scsi_host/*/link_power_management_policy <<< min_power > /dev/null
tee /sys/bus/i2c/devices/*/device/power/control <<< auto > /dev/null
tee /sys/bus/pci/devices/*/power/control <<< auto > /dev/null

for dir in /sys/bus/usb/devices/*; do
    # Some keyboards/mice don't really react well to being suspended.
    prod_file=$dir/product
    if [[ -e $prod_file ]] && [[ "$(cat "$prod_file")" == *@(Keyboard|Mouse)* ]]; then
        continue
    fi
    tee "$dir"/power/control <<< auto > /dev/null
done

tee /sys/module/snd_hda_intel/parameters/power_save <<< 1 > /dev/null
tee /proc/sys/kernel/nmi_watchdog <<< 0 > /dev/null

for device in /sys/class/net/e*; do
    device=${device##*/}
    ethtool -s "$device" wol d
done
